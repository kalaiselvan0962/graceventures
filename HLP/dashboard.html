<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizklub | Employee Dashboard</title>
            <link rel="stylesheet" href="style.css"> <!-- This line links your CSS -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
     <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD4hyxY6IP4aNp7e0UHjhshH64NvGvtEAo",
        authDomain: "issuetracker-df444.firebaseapp.com",
        projectId: "issuetracker-df444",
        storageBucket: "issuetracker-df444.firebasestorage.app",
        messagingSenderId: "80331965649",
        appId: "1:80331965649:web:e1022467ffc19c41a9b1f0",
        measurementId: "G-9R0J9NVLQE"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    console.log('‚úÖ Firebase initialized in dashboard');
</script>
</head>


<body>
    <!-- Animated Background -->
    <div class="background">
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
            <div class="shape shape-5"></div>
        </div>
        <div class="light-beam"></div>
    </div>

    <!-- Dashboard Header -->
    <header class="dashboard-header">
       <!-- With this -->
<div class="logo-section">
    <div class="logo-icon">
        <img src="wk.svg" class="logo-svg" alt="Wizklub Logo">
    </div>
    <div class="logo-text">
        <p>Instructors Helpline</p>
    </div>
</div>
        <div class="user-section">
            <div class="user-info">
    <div class="user-name" id="employeeName">John Doe</div>
    <div class="user-position" id="employeePosition">Software Engineer</div>
    <div class="user-details">
        <span class="school-info" id="schoolInfo"><i class="fas fa-school"></i> Loading...</span>
        <span class="location-info" id="locationInfo"><i class="fas fa-map-marker-alt"></i> Loading...</span>
    </div>
</div>
            <button class="raise-ticket-btn" onclick="raiseTicket()">
                <i class="fas fa-plus-circle"></i>
                Raise Ticket
            </button>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </header>

    <!-- Main Dashboard Content -->
    <div class="dashboard-container">
        <div class="dashboard-card">
            <div class="tracker-header">
                <div class="header-left">
                    <h1 id="dashboard-title">My Tickets</h1>
                    <p id="dashboard-subtitle">View and track your submitted issues</p>
                </div>
                <div class="header-right">
                    <div class="update-indicator">
                        <div class="status-dot"></div>
                        <span id="update-time">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search issues...">
                </div>
                <div class="filter-controls">
                    <select id="status-filter">
                        <option value="all">All Statuses</option>
                        <option value="To Do">To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Done">Done</option>
                    </select>
                    <select id="priority-filter">
                        <option value="all">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
            </div>
            
            <div class="issues-container">
                <div id="data-container">
                    <div class="loading">Fetching your tickets...</div>
                </div>
            </div>
            
            <footer>
                <p>Synced Now üöÄ <span id="refresh-interval"></span>Secs ago</p>
            </footer>
        </div>
    </div>
<script>
// === UPDATE DOMContentLoaded ===
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ DOMContentLoaded - Starting application');
    
    const employeeData = getEmployeeData();
    
    if (employeeData && employeeData.name) {
        console.log('üë§ Employee data found:', employeeData.name, '(', employeeData.userType, ')');
        displayEmployeeInfo(employeeData);
        
        // Initialize tracker immediately
        initializeTracker();
        
        // Try to fetch school/location from Firebase if available
        setTimeout(async () => {
            try {
                await fetchAndDisplaySchoolLocation(employeeData);
            } catch (error) {
                console.log('‚ö†Ô∏è Could not fetch school/location:', error);
                showDefaultSchoolLocation();
            }
        }, 1000);
        
    } else {
        console.log('‚ùå No valid employee data, redirecting to login');
        window.location.href = 'index.html';
    }
});

// Fetch and display school and location from Firebase using Modular SDK
async function fetchAndDisplaySchoolLocation(employeeData) {
    try {
        // Check if Firebase Modular SDK is available
        if (typeof db === 'undefined') {
            console.log('‚ùå Firebase db not available');
            showDefaultSchoolLocation();
            return;
        }

        const empid = employeeData.empid || employeeData.id;
        console.log(`üì° Fetching school/location from Firebase for: ${empid}`);
        
        // Use Modular SDK syntax
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
        
        const docRef = doc(db, "employees", empid);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const firebaseData = docSnap.data();
            console.log('‚úÖ Firebase data received:', firebaseData);
            
            // Update school information display
            const schoolInfoElement = document.getElementById('schoolInfo');
            if (firebaseData.school) {
                schoolInfoElement.innerHTML = `<i class="fas fa-school"></i> ${firebaseData.school}`;
                schoolInfoElement.style.display = 'inline-flex';
                schoolInfoElement.style.opacity = '1';
                console.log(`üè´ School: ${firebaseData.school}`);
            } else {
                schoolInfoElement.innerHTML = `<i class="fas fa-school"></i> Not specified`;
                schoolInfoElement.style.opacity = '0.6';
            }
            
            // Update location information display
            const locationInfoElement = document.getElementById('locationInfo');
            if (firebaseData.location) {
                locationInfoElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${firebaseData.location}`;
                locationInfoElement.style.display = 'inline-flex';
                locationInfoElement.style.opacity = '1';
                console.log(`üìç Location: ${firebaseData.location}`);
            } else {
                locationInfoElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> Not specified`;
                locationInfoElement.style.opacity = '0.6';
            }
            
        } else {
            console.log('‚ùå No employee document found in Firebase');
            showDefaultSchoolLocation();
        }
    } catch (error) {
        console.error('‚ùå Error fetching school/location:', error);
        showDefaultSchoolLocation();
    }
}

// Function to show default values when Firebase fails
function showDefaultSchoolLocation() {
    const schoolInfoElement = document.getElementById('schoolInfo');
    const locationInfoElement = document.getElementById('locationInfo');
    
    schoolInfoElement.innerHTML = `<i class="fas fa-school"></i> Not available`;
    locationInfoElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> Not available`;
    
    schoolInfoElement.style.opacity = '0.5';
    locationInfoElement.style.opacity = '0.5';
}

// Fetch employee data from Firebase using Modular SDK
async function fetchEmployeeFromFirebase(empid) {
    try {
        console.log(`üì° Fetching employee data from Firebase for: ${empid}`);
        
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
        
        const docRef = doc(db, "employees", empid);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            console.log('‚úÖ Firebase data retrieved:', data);
            return data;
        } else {
            console.log('‚ùå No employee found in Firebase with ID:', empid);
            return null;
        }
    } catch (error) {
        console.error('‚ùå Error fetching from Firebase:', error);
        return null;
    }
}

// Refresh manager data using Modular SDK
async function refreshManagerData() {
    try {
        const employeeData = getEmployeeData();
        if (!employeeData) return null;
        
        const empid = employeeData.empid || employeeData.id;
        const userType = employeeData.userType;
        
        if (userType === 'account_manager' || userType === 'program_manager') {
            const firebaseData = await fetchEmployeeFromFirebase(empid);
            
            if (firebaseData) {
                const updatedData = {
                    ...employeeData,
                    ...firebaseData,
                    // Preserve school and location from Firebase
                    school: firebaseData.school || employeeData.school,
                    location: firebaseData.location || employeeData.location,
                    managedEmployees: firebaseData.managedEmployees || employeeData.managedEmployees || []
                };
                
                localStorage.setItem('employeeData', JSON.stringify(updatedData));
                
                // Update school/location display for managers too
                await fetchAndDisplaySchoolLocation(updatedData);
                
                return updatedData;
            }
        }
        
        return employeeData;
    } catch (error) {
        console.error('‚ùå Error in refreshManagerData:', error);
        return getEmployeeData();
    }
}

function getEmployeeData() {
    try {
        // Try localStorage first, then sessionStorage
        const localStorageData = localStorage.getItem('employeeData');
        const sessionStorageData = sessionStorage.getItem('currentEmployee');
        
        let employeeData = null;
        
        if (localStorageData) {
            employeeData = JSON.parse(localStorageData);
        } else if (sessionStorageData) {
            employeeData = JSON.parse(sessionStorageData);
        }
        
        // Validate employee data
        if (employeeData && employeeData.id && employeeData.name && employeeData.position) {
            return employeeData;
        }
    } catch (error) {
        console.error('Error parsing employee data:', error);
    }
    
    return null;
}

// === getManagedEmployees FUNCTION WITH COMPLETE HARDCODED VALUES ===
function getManagedEmployees(employeeData) {
    if (!employeeData) {
        console.log('‚ùå No employee data in getManagedEmployees');
        return [];
    }
    
    const empid = employeeData.empid || employeeData.id;
    const userType = employeeData.userType;
    const name = employeeData.name;
    
    console.log(`üîç getManagedEmployees for ${name} (${userType}) - ID: ${empid}`);
    
    // Only managers should have managed employees
    if (userType !== 'account_manager' && userType !== 'program_manager') {
        console.log('‚ùå User is not a manager type');
        return [];
    }
    
    // Check for managedEmployees array
    if (employeeData.managedEmployees && Array.isArray(employeeData.managedEmployees)) {
        if (employeeData.managedEmployees.length > 0) {
            console.log('‚úÖ Found managedEmployees array:', employeeData.managedEmployees);
            return employeeData.managedEmployees;
        } else {
            console.log('‚ö†Ô∏è managedEmployees array exists but is empty');
        }
    }
    
    // Check for manageEmployees string (legacy format)
    if (employeeData.manageEmployees && typeof employeeData.manageEmployees === 'string') {
        const employees = employeeData.manageEmployees.split(',')
            .map(emp => emp.trim())
            .filter(emp => emp && emp.trim() !== '');
        console.log('‚úÖ Found manageEmployees string, converted to array:', employees);
        return employees;
    }
    
    // === COMPLETE HARDCODED FALLBACK EMPIDs FOR ALL MANAGERS ===
    console.log('üîÑ Using hardcoded EMPID fallbacks for', userType);
    
    if (name === 'HimanshuVerma' || empid === 'HYD603385') {
        const hardcodedEmployees = [
            'RET244', 'EMP3715', 'RET247', 'EMP3722', 'EMP3782', 
            'RET260', 'EMP3635', 'RET276', 'RET723', 'RET255', 
            'EMP3772', 'EMP3771', 'RET248', 'RET253', 'HYD603396', 'RET284'
        ];
        console.log('üéØ HimanshuVerma (Area Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    } 
    else if (name === 'Aditi Ashok Katti' || empid === 'EMP2470') {
        const hardcodedEmployees = [
            'RET244', 'EMP3715', 'RET247', 'EMP3722', 'EMP3782', 
            'RET260', 'EMP3635', 'RET276', 'RET723', 'RET255', 
            'EMP3772', 'EMP3771', 'RET248', 'RET253', 'HYD603396', 'RET284',
            'EMP3714', 'RET269', 'HYD603412', 'HYD603388', 'EMP3742', 
            'RET275', 'RET264', 'RET290', 'EMP3718', 'EMP3775', 
            'EMP3710', 'RET252',
            'EMP2470', 'HYD603385'
        ];
        console.log('üéØ Aditi Ashok Katti (Program Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    }
    else if (name === 'John Emmanuel' || empid === 'EMP665') {
        const hardcodedEmployees = [
            'EMP3632', 'EMP3784', 'EMP670', 'EMP3778', 'EMP3701', 'EMP737', 
            'EMP3792', 'EMP3756', 'EMP3769', 'EMP3268', 'HYD603372', 'EMP3661', 
            'EMP3728', 'HYD603563', 'EMP576', 'EMP3767', 'HYD607795', 'EMP3757', 
            'EMP3763', 'EMP3707', 'EMP3758', 'EMP3744', 'EMP3773', 'RET289', 
            'EMP3646', 'EMP3793', 'EMP3755', 'RET267', 'EMP3681', 'EMP3667', 
            'EMP2957', 'EMP3626', 'EMP3668', 'EMP3787'
        ];
        console.log('üéØ John Emmanuel (Area Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    }
    else if (name === 'MEENA' || empid === 'HYD603338') {
        const hardcodedEmployees = [
            'EMP3632', 'EMP3784', 'EMP670', 'EMP3778', 'EMP3701', 'EMP737', 
            'EMP3792', 'EMP3756', 'EMP3769', 'EMP3268', 'HYD603372', 'EMP3661', 
            'EMP3728', 'HYD603563', 'EMP576', 'EMP3767', 'HYD607795', 'EMP3757', 
            'EMP3763', 'EMP3707', 'EMP3758', 'EMP3744', 'EMP3773', 'RET289', 
            'EMP3646', 'EMP3793', 'EMP3755', 'RET267', 'EMP3681', 'EMP3667', 
            'EMP2957', 'EMP3626', 'EMP3668', 'EMP3787',
            'EMP3593', 'EMP3777', 'EMP3745', 'RET256', 'EMP3716', 'RET278', 
            'EMP3789', 'RET243', 'RET227', 'RET291', 'EMP743', 'EMP3770', 
            'RET228', 'RET277', 'RET268', 'RET288', 'EMP3759', 'EMP3683', 
            'EMP3788', 'EMP3791', 'EMP734', 'EMP3721',
            'EMP665', 'EMP060', 'HYD603338'
        ];
        console.log('üéØ MEENA (Program Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    }
    else if (name === 'S Sandeep Kumar' || empid === 'EMP060') {
        const hardcodedEmployees = [
            'EMP3593', 'EMP3777', 'EMP3745', 'RET256', 'EMP3716', 'RET278', 
            'EMP3789', 'RET243', 'RET227', 'RET291', 'EMP743', 'EMP3770', 
            'RET228', 'RET277', 'RET268', 'RET288', 'EMP3759', 'EMP3683', 
            'EMP3788', 'EMP3791', 'EMP734', 'EMP3721'
        ];
        console.log('üéØ S Sandeep Kumar (Area Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    }
    else if (name === 'Rishav Kumar' || empid === 'HYD603381') {
        const hardcodedEmployees = [
            'EMP3785', 'EMP3766', 'RET246', 'EMP626', 'EMP3774', 'EMP850', 
            'EMP3717', 'EMP3743', 'EMP3786', 'RET266', 'EMP3260', 'RET265', 
            'RET286', 'EMP3740', 'EMP3761', 'HYD603319', 'EMP3747', 'RET287', 
            'EMP3768', 'RET270', 'EMP3781', 'RET282', 'EMP3764', 'RET251', 
            'EMP3780', 'RET285', 'EMP3754', 'EMP3689', 'RET283', 'EMP3376', 
            'EMP3154', 'EMP3703', 'EMP3760', 'EMP3723', 'EMP3783', 'EMP3776', 
            'EMP3779', 'RET281', 'EMP3630', 'EMP3684', 'EMP3705', 'EMP3665'
        ];
        console.log('üéØ Rishav Kumar (Area Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    }
    else if (name === 'PADMAJA' || empid === 'EMP679') {
        const hardcodedEmployees = [
            'EMP3785', 'EMP3766', 'RET246', 'EMP626', 'EMP3774', 'EMP850', 
            'EMP3717', 'EMP3743', 'EMP3786', 'RET266', 'EMP3260', 'RET265', 
            'RET286', 'EMP3740', 'EMP3761', 'HYD603319', 'EMP3747', 'RET287', 
            'EMP3768', 'RET270', 'EMP3781', 'RET282', 'EMP3764', 'RET251', 
            'EMP3780', 'RET285', 'EMP3754', 'EMP3689', 'RET283', 'EMP3376', 
            'EMP3154', 'EMP3703', 'EMP3760', 'EMP3723', 'EMP3783', 'EMP3776', 
            'EMP3779', 'RET281', 'EMP3630', 'EMP3684', 'EMP3705', 'EMP3665',
            'HYD603381', 'EMP679'
        ];
        console.log('üéØ PADMAJA (Program Manager) hardcoded EMPIDs:', hardcodedEmployees);
        return hardcodedEmployees;
    }
    
    // Generic fallbacks for other managers
    if (userType === 'program_manager') {
        const fallbackEmployees = ['EMP2470', 'HYD603385', 'EMP665', 'EMP060', 'HYD603381'];
        console.log('üéØ Generic Program Manager fallback EMPIDs:', fallbackEmployees);
        return fallbackEmployees;
    } else if (userType === 'account_manager') {
        const fallbackEmployees = ['RET244', 'EMP3715', 'RET247', 'EMP3722'];
        console.log('üéØ Generic Area Manager fallback EMPIDs:', fallbackEmployees);
        return fallbackEmployees;
    }
    
    console.log('‚ùå No managed employees found in employee data');
    return [];
}

function displayEmployeeInfo(employeeData) {
    document.getElementById('employeeName').textContent = employeeData.name;
    
    // Set user-friendly role display
    let roleDisplay = '';
    switch(employeeData.userType) {
        case 'program_manager':
            roleDisplay = 'Program Manager';
            break;
        case 'account_manager':
            roleDisplay = 'Account Manager';
            break;
        case 'assignee':
            roleDisplay = 'Assignee';
            break;
        case 'admin':
            roleDisplay = 'Administrator';
            break;
        default:
            roleDisplay = 'Employee';
    }
    
    // Build position text WITHOUT school and location (they will be displayed separately)
    let positionText = `${employeeData.position} (${roleDisplay})`;
    
    document.getElementById('employeePosition').textContent = positionText;
    
    // Update dashboard title based on user type
    const titleElement = document.getElementById('dashboard-title');
    const subtitleElement = document.getElementById('dashboard-subtitle');
    
    switch(employeeData.userType) {
        case 'employee':
            titleElement.textContent = 'My Tickets üé´ ';
            subtitleElement.textContent = 'View and track your submitted tickets';
            break;
        case 'program_manager':
            titleElement.textContent = 'Team Tickets üé´';
            subtitleElement.textContent = 'View tickets from your program team';
            break;
        case 'account_manager':
            titleElement.textContent = 'Team Tickets üé´ - Arena ';
            subtitleElement.textContent = 'View tickets from your TN team';
            break;
        case 'assignee':
            titleElement.textContent = 'Assigned Tickets üé´';
            subtitleElement.textContent = 'View and manage tickets assigned to you';
            break;
        case 'admin':
            titleElement.textContent = 'All Tickets üé´';
            subtitleElement.textContent = 'View and manage all system tickets';
            break;
    }
    
    console.log(`User logged in: ${employeeData.name} - ${employeeData.position} - ${employeeData.userType}`);
    
    // Update avatar with employee initials and location badge if available
    updateUserAvatar(employeeData);
}

function updateUserAvatar(employeeData) {
    let avatar = document.querySelector('.user-avatar');
    
    if (!avatar) {
        const userSection = document.querySelector('.user-section');
        avatar = document.createElement('div');
        avatar.className = 'avatar user-avatar';
        userSection.insertBefore(avatar, userSection.firstChild);
    }
    
    const initials = employeeData.name.split(' ').map(n => n[0]).join('').toUpperCase();
    avatar.textContent = initials;
    
    // Add location badge if location data is available
    if (employeeData.location) {
        // Remove existing location badge if any
        const existingBadge = avatar.querySelector('.location-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        const locationBadge = document.createElement('div');
        locationBadge.className = 'location-badge';
        locationBadge.title = employeeData.location;
        locationBadge.innerHTML = `<i class="fas fa-map-marker-alt"></i>`;
        avatar.appendChild(locationBadge);
    }
}

// Raise Ticket function
function raiseTicket() {
    window.location.href = 'raisetickets.html';
}

// Logout function - Clear all stored data
function logout() {
    localStorage.removeItem('employeeData');
    sessionStorage.removeItem('currentEmployee');
    window.location.href = 'index.html';
}

// Jira Tracker Functionality
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxxUX2PVC6urTMgc-wbqmfbfuIfViyZBQnIsuoJNXQJpJxfyQJna16QCdAR3f-h1H_FKg/exec'; 
const POLLING_INTERVAL = 10000; 

let currentData = [];

function initializeTracker() {
    // Fetch data immediately
    fetchSheetData(); 
    
    // Set up the polling mechanism
    setInterval(fetchSheetData, POLLING_INTERVAL);
    
    // Set up event listeners for filters
    setupEventListeners();
    
    // Update the refresh interval display
    document.getElementById('refresh-interval').textContent = POLLING_INTERVAL / 1000;
    
    console.log(`Jira-style tracker initialized. Refreshing every ${POLLING_INTERVAL / 1000} seconds.`);
}

async function fetchSheetData() {
    try {
        console.log('üîÑ Starting data fetch from Google Sheets...');
        
        // Use JSONP to bypass CORS
        const jsonpUrl = `${GAS_WEB_APP_URL}?callback=handleData&timestamp=${new Date().getTime()}`;
        console.log('üì° Fetching from:', jsonpUrl);
        
        // Remove any existing script
        const existingScript = document.getElementById('jsonp-script');
        if (existingScript) {
            existingScript.remove();
        }
        
        // Create script element for JSONP
        const script = document.createElement('script');
        script.id = 'jsonp-script';
        script.src = jsonpUrl;
        
        // Add error handling for script load
        script.onerror = function() {
            console.error('‚ùå Script load failed - CORS or URL issue');
            showError('Failed to load data. Check Web App URL and permissions.');
        };
        
        document.head.appendChild(script);
        
    } catch (error) {
        console.error("‚ùå Could not fetch data:", error);
        showError('Network error: ' + error.message);
    }
}

// Enhanced handleData function with better error handling
function handleData(response) {
    console.log('üì® Received response from Google Apps Script:', response);
    
    if (response && response.data) {
        currentData = response.data;
        const employeeData = getEmployeeData();
        
        console.log(`üìä Total issues in sheet: ${currentData.length}`);
        console.log(`üë§ User type: ${employeeData.userType}`);
        
        if (currentData.length === 0) {
            console.log('‚ö†Ô∏è No data returned from sheet');
        }
        
        const filteredData = applyFilters(currentData);
        console.log(`üéØ Filtered tickets for ${employeeData.userType}: ${filteredData.length}`);
        
        renderTable(filteredData);
        document.getElementById('update-time').innerHTML = `Last updated: ${new Date().toLocaleTimeString()}`;
        
    } else if (response && response.error) {
        console.error('‚ùå Google Apps Script Error:', response.error);
        showError('Server error: ' + response.error);
    } else {
        console.error('‚ùå Invalid response format:', response);
        showError('Invalid response from server. Check console for details.');
    }
}

function showError(message) {
    document.getElementById('data-container').innerHTML = 
        `<div class="error">
            <h3>Error loading data</h3>
            <p>${message}</p>
            <p><small>Check the Web App URL: ${GAS_WEB_APP_URL}</small></p>
            <button onclick="fetchSheetData()" style="margin-top: 10px; padding: 8px 16px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Retry
            </button>
        </div>`;
}

// UPDATED applyFilters FUNCTION WITH EXACT COLUMN NAMES
function applyFilters(data) {
    const statusFilter = document.getElementById('status-filter').value;
    const priorityFilter = document.getElementById('priority-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const employeeData = getEmployeeData();
    const currentEmpID = employeeData ? employeeData.empid : null;
    const userName = employeeData ? employeeData.name : '';
    const userType = employeeData ? employeeData.userType : 'employee';
    
    console.log(`üîç Applying filters - User: ${userName}, Type: ${userType}, EMPID: ${currentEmpID}`);
    
    const filteredData = data.filter(issue => {
        // UPDATED: Use exact column names
        const issueEmpID = issue['EMPID (Ex:EMP737)'] || issue.EMPID || '';
        const issueName = issue['name'] || issue.Name || '';
        
        // User-based filtering
        let shouldShow = false;
        
        switch(userType) {
            case 'employee':
                shouldShow = currentEmpID && issueEmpID === currentEmpID;
                break;
                
            case 'account_manager':
            case 'program_manager':
                const managedEmployees = getManagedEmployees(employeeData);
                shouldShow = managedEmployees.includes(issueEmpID);
                break;
                
            case 'assignee':
                const assigneeValue = issue.Assignee || issue['Assigned To'] || issue.Assigned_empid || issue['Assigned EmpID'] || '';
                shouldShow = assigneeValue === userName;
                break;
                
            case 'admin':
                shouldShow = true;
                break;
                
            default:
                shouldShow = false;
        }
        
        if (!shouldShow) return false;
        
        // Apply other filters (status, priority, search)
        if (statusFilter !== 'all' && issue.Status !== statusFilter) {
            return false;
        }
        
        if (priorityFilter !== 'all' && issue.Priority !== priorityFilter) {
            return false;
        }
        
        // UPDATED: Search with exact column names for school and location
        if (searchTerm && !(
            (issue.Category || '').toLowerCase().includes(searchTerm) ||
            (issue.Issue || '').toLowerCase().includes(searchTerm) ||
            (issueEmpID || '').toString().includes(searchTerm) ||
            (issueName || '').toLowerCase().includes(searchTerm) ||
            (issue['School '] || '').toLowerCase().includes(searchTerm) || // Exact column name
            (issue['Location '] || '').toLowerCase().includes(searchTerm) || // Exact column name
            (issue.Assignee || issue['Assigned To'] || issue.Assigned_empid || '').toLowerCase().includes(searchTerm) ||
            (issue.Screenshot || issue['Screenshot URL'] || '').toLowerCase().includes(searchTerm) ||
            (issue.Remarks || issue['Additional Remarks'] || issue.Comments || issue['Remarks from Assignee'] || issue['Resolution Remarks'] || issue['Admin Remarks'] || '').toLowerCase().includes(searchTerm)
        )) {
            return false;
        }
        return true;
    });
    
    console.log(`üéØ Final filtered tickets for ${userType}: ${filteredData.length}`);
    return filteredData;
}// UPDATED renderTable FUNCTION WITH EXACT COLUMN NAMES
function renderTable(data) {
    const container = document.getElementById('data-container');
    const employeeData = getEmployeeData();
    const userType = employeeData ? employeeData.userType : 'employee';
    
    // Define which user types can update status
    const canUpdateStatus = userType === 'assignee' || userType === 'admin' || 
                           userType === 'account_manager' || userType === 'program_manager';
    
    if (!data || data.length === 0) {
        let message = '';
        switch(userType) {
            case 'employee':
                message = 'You haven\'t submitted any tickets yet. Click "Raise Ticket" to create one.';
                break;
            case 'program_manager':
                message = 'No tickets from your program team. Employees can raise tickets that will appear here.';
                break;
            case 'account_manager':
                message = 'No tickets from your area team. Employees can raise tickets that will appear here.';
                break;
            case 'assignee':
                message = 'No tickets assigned to you.';
                break;
            default:
                message = 'No tickets found.';
        }
        
        container.innerHTML = `
            <div class="empty-state">
                <h3>No tickets found</h3>
                <p>${message}</p>
                ${userType === 'assignee' ? '<p style="margin-top: 10px; font-size: 12px; color: #64748b;">Your name: <strong>' + employeeData.name + '</strong></p>' : ''}
            </div>
        `;
        return;
    }

    // DEBUG: Log the first row to see actual column names
    console.log('üìã First row column names:', Object.keys(data[0]));
    console.log('üîç First row data:', data[0]);

    let html = `
        <table>
            <thead>
                <tr>
                    <th>EMP ID</th>
                    <th>Name</th>
                    <th>School</th>
                    <th>Location</th>
                    <th>Category</th>
                    <th>Issue</th>
                    <th>Screenshot</th>
                    <th>Remarks</th>
                    <th>Priority</th>
                    <th>Assignee</th>
                    <th>Status</th>
                    ${canUpdateStatus ? '<th>Actions</th>' : ''}
                </tr>
            </thead>
            <tbody>
    `;
    
    data.forEach(issue => {
        let statusClass = 'status-todo';
        if (issue.Status === 'In Progress') statusClass = 'status-in-progress';
        if (issue.Status === 'Done') statusClass = 'status-done';
        
        let priorityClass = 'priority-low';
        if (issue.Priority === 'High') priorityClass = 'priority-high';
        if (issue.Priority === 'Medium') priorityClass = 'priority-medium';
        
        // Use exact column names from Google Sheets
        const empId = issue['EMPID (Ex:EMP737)'] || issue.EMPID || '-';
        const name = issue['name'] || issue.Name || '-';
        
        // EXACT column names from Google Sheets
        const school = issue['School '] || 'Not specified'; // Note the space after 'School'
        const location = issue['Location '] || 'Not specified'; // Note the space after 'Location'
        
        const category = issue.Category || '-';
        const issueDescription = issue.Issue || issue.Description || '';
        const status = issue.Status || 'To Do';
        const priority = issue.Priority || 'Low';
        
        // Get assignee from multiple possible column names
        const assignee = issue.Assignee || 
                        issue['Assigned To'] || 
                        issue.Assigned_empid || 
                        issue['Assigned EmpID'] || 
                        'Unassigned';
        
        const rowId = issue.rowId || '';
        
        // Get screenshot URL
        const screenshotUrl = issue.Screenshot || 
                             issue['Screenshot URL'] || 
                             issue['Attachment'] || 
                             '';
        
        // Get remarks from multiple possible column names
        const remarks = issue.Remarks || 
                       issue['Additional Remarks'] || 
                       issue.Comments || 
                       issue['Remarks from Assignee'] ||
                       issue['Resolution Remarks'] ||
                       issue['Admin Remarks'] ||
                       issue['Remarks '] || // with space
                       '';

        const displayText = remarks || '-';
        const shouldTruncate = remarks && remarks.length > 30;
        const displayRemarks = shouldTruncate ? remarks.substring(0, 30) + '...' : displayText;

        // Get resolved timestamp
        const resolvedAt = issue['Resolved At'] || issue['Resolved_At'] || issue.resolvedAt || '';
        const lastUpdated = issue['Last Updated'] || issue['Last_Updated'] || issue.lastUpdated || '';
        
        const assigneeInitials = assignee !== 'Unassigned' ? 
            assignee.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
        
        // Screenshot cell
        const screenshotCell = screenshotUrl ? 
            `<td class="screenshot-cell">
                <a href="#" class="screenshot-link" onclick="showScreenshotPreview('${screenshotUrl}', '${name} - ${category}')">
                    <i class="fas fa-image"></i>
                    View Screenshot
                </a>
            </td>` :
            `<td><span class="no-screenshot">-</span></td>`;
        
        // Remarks cell with simple tooltip
        const remarksCell = `
            <td>
                <div class="tooltip ${remarks ? '' : 'no-remarks'}" 
                     data-tooltip="${remarks ? remarks.replace(/"/g, '&quot;') : 'No remarks'}">
                    ${displayRemarks}
                </div>
            </td>
        `;

        // Determine which action buttons to show
        let actionButtons = '';
        if (canUpdateStatus) {
            if (status === 'To Do') {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="status-update-btn mark-inprogress-btn" 
                                onclick="updateTicketStatus('${rowId}', 'In Progress')" 
                                title="Mark as In Progress">
                            <i class="fas fa-play-circle"></i>
                            Start
                        </button>
                    </div>
                `;
            } else if (status === 'In Progress') {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="status-update-btn mark-close-btn" 
                                onclick="updateTicketStatus('${rowId}', 'Done')" 
                                title="Mark as Done">
                            <i class="fas fa-check-circle"></i>
                            Close
                        </button>
                    </div>
                `;
            } else {
                // Show completed status with timestamp
                const displayTimestamp = resolvedAt || lastUpdated || 'Recently';
                actionButtons = `
                    <div class="completed-status">
                        <span class="completed-badge">
                            <i class="fas fa-check-circle"></i>
                            Completed
                        </span>
                        ${displayTimestamp ? `<span class="resolved-timestamp" title="Resolved at: ${displayTimestamp}">${formatTimestamp(displayTimestamp)}</span>` : ''}
                    </div>
                `;
            }
        }
        
        // Format status cell to show timestamp for completed tickets
        let statusCell = '';
        if (status === 'Done' && (resolvedAt || lastUpdated)) {
            const displayTimestamp = resolvedAt || lastUpdated;
            statusCell = `
                <td>
                    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                        <span class="status-badge ${statusClass}">${status}</span>
                        <span class="resolved-timestamp" title="Resolved at: ${displayTimestamp}">${formatTimestamp(displayTimestamp)}</span>
                    </div>
                </td>
            `;
        } else {
            statusCell = `<td><span class="status-badge ${statusClass}">${status}</span></td>`;
        }
        
        html += `
            <tr>
                <td>${empId}</td>
                <td>${name}</td>
                <td>${school}</td>
                <td>${location}</td>
                <td>${category}</td>
                <td><div class="issue-description" title="${issueDescription}">${issueDescription || '-'}</div></td>
                ${screenshotCell}
                ${remarksCell}
                <td><span class="priority-badge ${priorityClass}">${priority}</span></td>
                <td>
                    <div class="assignee">
                        <div class="avatar">${assigneeInitials}</div>
                        <span>${assignee}</span>
                    </div>
                </td>
                ${statusCell}
                ${canUpdateStatus ? `<td>${actionButtons}</td>` : ''}
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // Log access permissions for debugging
    console.log(`üîß User ${employeeData.name} (${userType}) can update status: ${canUpdateStatus}`);
}
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    
    // If it's already in a readable format, return as is
    if (typeof timestamp === 'string' && timestamp.includes('/')) {
        const parts = timestamp.split(' ');
        if (parts.length > 0) {
            return parts[0]; // Return just the date part
        }
        return timestamp;
    }
    
    // If it's an ISO string or other format, try to parse
    try {
        const date = new Date(timestamp);
        if (!isNaN(date.getTime())) {
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
    } catch (e) {
        console.log('Error parsing timestamp:', e);
    }
    
    return timestamp;
}

// Screenshot preview functionality
function showScreenshotPreview(imageUrl, title) {
    // Remove any existing modal first
    const existingModal = document.getElementById('screenshot-preview-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div class="screenshot-preview-modal" id="screenshot-preview-modal">
            <div class="screenshot-preview-content">
                <div class="screenshot-preview-header">
                    <div class="screenshot-preview-title">${title}</div>
                    <button class="screenshot-preview-close" onclick="closeScreenshotPreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <img src="${imageUrl}" alt="Issue Screenshot" class="screenshot-preview-img" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04MCA2MEgxMjBWODBIMzBWNjBaIiBmaWxsPSIjOTRBMUFFIi8+CjxjaXJjbGUgY3g9IjEwMCIgY3k9IjQ1IiByPSIxNSIgZmlsbD0iIzk0QTFBRSIvPgo8L3N2Zz4K'; this.alt='Image failed to load'">
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add click outside to close
    document.getElementById('screenshot-preview-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeScreenshotPreview();
        }
    });
    
    // Add escape key to close
    document.addEventListener('keydown', handleScreenshotKeydown);
}

function closeScreenshotPreview() {
    const modal = document.getElementById('screenshot-preview-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease forwards';
        modal.querySelector('.screenshot-preview-content').style.animation = 'scaleOut 0.3s ease forwards';
        
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    
    document.removeEventListener('keydown', handleScreenshotKeydown);
}

function handleScreenshotKeydown(e) {
    if (e.key === 'Escape') {
        closeScreenshotPreview();
    }
}

// MODAL VERSION - updateTicketStatus function
function updateTicketStatus(rowId, newStatus) {
    const employeeData = getEmployeeData();
    if (!employeeData) return;
    
    const statusConfig = {
        'In Progress': {
            title: 'Start Working on Ticket',
            message: 'Are you sure you want to start working on this ticket? This will change the status to "In Progress".',
            icon: 'fa-play-circle',
            confirmText: 'Start Working',
            type: 'in-progress'
        },
        'Done': {
            title: 'Close Ticket',
            message: 'Are you sure you want to close this ticket? This will mark it as completed and record the resolution time.',
            icon: 'fa-check-circle',
            confirmText: 'Close Ticket',
            type: 'done'
        }
    };
    
    const config = statusConfig[newStatus];
    
    // Create modal
    showStatusModal(config, () => {
        // This callback runs when user confirms
        performStatusUpdate(rowId, newStatus, employeeData.name);
    });
}

// Function to perform the actual status update
async function performStatusUpdate(rowId, newStatus, updatedBy) {
    try {
        const updateData = {
            action: 'updateStatus',
            rowId: parseInt(rowId),
            status: newStatus,
            updatedBy: updatedBy,
            timestamp: new Date().toISOString()
        };
        
        console.log('Sending status update request:', updateData);
        
        // Use URL parameters instead of POST body to avoid CORS
        const params = new URLSearchParams();
        params.append('action', updateData.action);
        params.append('rowId', updateData.rowId);
        params.append('status', updateData.status);
        params.append('updatedBy', updateData.updatedBy);
        params.append('timestamp', updateData.timestamp);
        
        const updateUrl = `${GAS_WEB_APP_URL}?${params.toString()}`;
        
        // Show loading state
        showNotification(`Updating ticket status to ${newStatus}...`, 'success');
        
        const response = await fetch(updateUrl, {
            method: 'POST',
            mode: 'no-cors' // Use no-cors mode
        });
        
        // Since we use no-cors, we can't read the response, but the update should still happen
        showNotification(`Ticket status updated to ${newStatus} successfully! Refreshing data...`, 'success');
        
        // Refresh data after a short delay to see the changes
        setTimeout(fetchSheetData, 2000);
        
    } catch (error) {
        console.error('Error updating ticket status:', error);
        showNotification('Status update sent. Refreshing to confirm changes...', 'success');
        // Still refresh to check if update worked
        setTimeout(fetchSheetData, 2000);
    }
}

// Function to show status confirmation modal
function showStatusModal(config, onConfirm) {
    // Remove any existing modal first
    const existingModal = document.getElementById('status-update-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div class="modal-overlay" id="status-update-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon ${config.type}">
                        <i class="fas ${config.icon}"></i>
                    </div>
                    <h3 class="modal-title">${config.title}</h3>
                </div>
                <p class="modal-message">${config.message}</p>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeStatusModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="modal-btn confirm ${config.type === 'done' ? 'done' : ''}" 
                            onclick="confirmStatusUpdate()">
                        <i class="fas ${config.icon}"></i>
                        ${config.confirmText}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    window.currentStatusUpdateCallback = onConfirm;
    
    document.addEventListener('keydown', handleModalKeydown);
}

function handleModalKeydown(e) {
    if (e.key === 'Escape') {
        closeStatusModal();
    } else if (e.key === 'Enter') {
        const confirmBtn = document.querySelector('.modal-btn.confirm');
        if (confirmBtn) {
            confirmStatusUpdate();
        }
    }
}

// Function to close the modal
function closeStatusModal() {
    const modal = document.getElementById('status-update-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease forwards';
        modal.querySelector('.modal-content').style.animation = 'slideDown 0.3s ease forwards';
        
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    
    // Clean up
    window.currentStatusUpdateCallback = null;
    document.removeEventListener('keydown', handleModalKeydown);
}

// Function called when user confirms the status update
function confirmStatusUpdate() {
    if (window.currentStatusUpdateCallback) {
        window.currentStatusUpdateCallback();
    }
    closeStatusModal();
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function setupEventListeners() {
    document.getElementById('status-filter').addEventListener('change', () => {
        const filteredData = applyFilters(currentData);
        renderTable(filteredData);
    });
    
    document.getElementById('priority-filter').addEventListener('change', () => {
        const filteredData = applyFilters(currentData);
        renderTable(filteredData);
    });
    
    document.getElementById('search-input').addEventListener('input', () => {
        const filteredData = applyFilters(currentData);
        renderTable(filteredData);
    });
}
</script>
</body>
</html>