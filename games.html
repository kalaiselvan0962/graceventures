<script>
  document.addEventListener('DOMContentLoaded', function () {
    const targetPatternContainer = document.getElementById('target-pattern');
    const dropArea = document.getElementById('drop-area');
    const colorPalette = document.getElementById('color-palette');
    const popup = document.getElementById('popup');

    const dragSound = document.getElementById('drag-sound');
    const dropSound = document.getElementById('drop-sound');
    const successSound = document.getElementById('success-sound');
    const failSound = document.getElementById('fail-sound');

    const colors = ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA'];
    let targetPattern = [];

    let touchColor = null;

    function generateTargetPattern() {
      targetPattern = [];
      targetPatternContainer.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const color = colors[Math.floor(Math.random() * colors.length)];
        targetPattern.push(color);
        const box = document.createElement('div');
        box.className = 'color-box';
        box.style.backgroundColor = color;
        targetPatternContainer.appendChild(box);
      }
    }

    function createDropBoxes() {
      dropArea.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const box = document.createElement('div');
        box.className = 'color-box';
        box.dataset.index = i;

        // Desktop
        box.addEventListener('dragover', (e) => e.preventDefault());
        box.addEventListener('drop', onDrop);

        // Mobile
        box.addEventListener('touchend', function (e) {
          if (touchColor) {
            this.style.backgroundColor = touchColor;
            dropSound.play();
            touchColor = null;
            setTimeout(() => {
              if (isAllFilled()) checkSolution();
            }, 100);
          }
        });

        dropArea.appendChild(box);
      }
    }

    function createColorPalette() {
      colorPalette.innerHTML = '';
      colors.forEach(color => {
        const colorBox = document.createElement('div');
        colorBox.className = 'color-box';
        colorBox.style.backgroundColor = color;
        colorBox.draggable = true;

        // Desktop drag
        colorBox.addEventListener('dragstart', (e) => {
          dragSound.play();
          e.dataTransfer.setData('text/plain', color);
        });

        // Mobile touch
        colorBox.addEventListener('touchstart', function (e) {
          touchColor = color;
          dragSound.play();
        });

        colorPalette.appendChild(colorBox);
      });
    }

    function onDrop(e) {
      e.preventDefault();
      const color = e.dataTransfer.getData('text/plain');
      e.target.style.backgroundColor = color;
      dropSound.play();
      setTimeout(() => {
        if (isAllFilled()) checkSolution();
      }, 100);
    }

    function isAllFilled() {
      const boxes = dropArea.querySelectorAll('.color-box');
      return Array.from(boxes).every(box => box.style.backgroundColor && box.style.backgroundColor !== 'white');
    }

    function checkSolution() {
      const boxes = dropArea.querySelectorAll('.color-box');
      let correct = true;

      boxes.forEach((box, index) => {
        const placedColor = rgbToHex(box.style.backgroundColor);
        const targetColor = rgbToHex(targetPattern[index]);
        if (placedColor !== targetColor) {
          correct = false;
        }
      });

      if (correct) {
        showPopup('ðŸŽ‰ Success! Well done!', true);
        successSound.play();
      } else {
        showPopup('ðŸ˜¢ Not quite. Try again!', false);
        failSound.play();
      }
    }

    function showPopup(message, isSuccess) {
      popup.textContent = message;
      popup.className = `popup show ${isSuccess ? 'success' : 'fail'}`;
      setTimeout(() => {
        popup.classList.remove('show');
      }, 3000);
    }

    function rgbToHex(rgb) {
      if (!rgb) return '';
      const result = /^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/.exec(rgb);
      return result
        ? '#' + result.slice(1).map(x => ('0' + parseInt(x).toString(16)).slice(-2)).join('').toUpperCase()
        : rgb.toUpperCase();
    }

    generateTargetPattern();
    createDropBoxes();
    createColorPalette();
  });
</script>
