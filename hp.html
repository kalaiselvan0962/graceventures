<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sorting Hat Â· 3D Experience with Sound</title>
    <!-- Harry Potter fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'IM Fell English SC', 'Cinzel Decorative', serif;
            background: #0a0c14;
        }

        /* Fullscreen 3D canvas */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        /* UI overlay â€“ interactive and clickable */
        #quiz-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
            background: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.6) 100%);
        }

        #quiz-panel {
            background: rgba(25, 20, 15, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 4px solid #b88a4b;
            border-radius: 60px 60px 30px 30px;
            padding: 2rem 2.5rem;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8), 0 0 0 3px #e4c38b inset, 0 0 40px #b87e3a;
            text-align: center;
            pointer-events: auto;
            color: #f7eed9;
            text-shadow: 2px 2px 0 #2f261c;
            transition: all 0.3s ease;
        }

        h1 {
            font-family: 'Cinzel Decorative', serif;
            font-size: 3.5rem;
            margin: 0 0 0.5rem;
            color: #f5e1b0;
            text-shadow: 0 0 15px #f6c97e, 4px 4px 0 #281c0e;
            letter-spacing: 4px;
        }

        .subtitle {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: #ecd8b4;
            border-bottom: 2px solid #b88a4b;
            padding-bottom: 0.5rem;
        }

        #question-area {
            transition: all 0.3s ease;
        }

        .question-text {
            font-size: 2.2rem;
            margin: 1rem 0 2rem;
            color: #ffefcf;
            text-shadow: 0 0 10px #eba45e;
            line-height: 1.4;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            border-radius: 50px;
            padding: 1rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 2rem 0;
        }

        .option-btn {
            background: rgba(60, 40, 25, 0.9);
            border: 3px solid #b88a4b;
            color: #faeacb;
            padding: 20px 10px;
            font-size: 1.6rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IM Fell English SC', serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 8px 0 #3f2e1d;
            width: 100%;
            pointer-events: auto;
        }

        .option-btn:hover {
            background: rgba(100, 70, 45, 0.9);
            border-color: #fae3af;
            transform: translateY(-2px);
            box-shadow: 0 10px 0 #3f2e1d;
        }

        .option-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #3f2e1d;
        }

        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 5px 0 #3f2e1d;
        }

        .voice-section {
            margin: 2rem 0;
            padding: 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 60px;
            border: 2px solid #b88a4b;
        }

        .mic-btn {
            background: #2a3a2a;
            border: 3px solid #b88a4b;
            color: #f7efd6;
            font-size: 1.8rem;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Cinzel Decorative', serif;
            box-shadow: 0 6px 0 #1a2a1a;
            margin-bottom: 1rem;
            width: auto;
            pointer-events: auto;
        }

        .mic-btn:hover {
            background: #3a4f3a;
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #1a2a1a;
        }

        .mic-btn.listening {
            background: #4a6f4a;
            box-shadow: 0 0 30px #b88a4b;
            border-color: #ffd98c;
        }

        .mic-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1a2a1a;
        }

        #voice-status {
            color: #f2dba5;
            font-size: 1.2rem;
            margin-top: 0.5rem;
            min-height: 2rem;
        }

        #result-area {
            padding: 2rem;
        }

        .result-house {
            font-size: 4rem;
            font-weight: 900;
            margin: 1.5rem 0;
            font-family: 'Cinzel Decorative', serif;
            text-transform: uppercase;
        }

        .house-Gryffindor { color: #e65c4b; text-shadow: 0 0 30px #ff4f4f; }
        .house-Hufflepuff { color: #fad75b; text-shadow: 0 0 30px #fcb42e; }
        .house-Ravenclaw { color: #8db1f0; text-shadow: 0 0 30px #5b7dda; }
        .house-Slytherin { color: #7ecf7a; text-shadow: 0 0 30px #35944b; }

        #restart-btn {
            background: rgba(60, 40, 25, 0.9);
            border: 4px solid #b88a4b;
            color: #f7efd6;
            font-size: 2rem;
            padding: 15px 50px;
            border-radius: 60px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IM Fell English SC', serif;
            margin-top: 2rem;
            box-shadow: 0 8px 0 #3f2e1d;
            pointer-events: auto;
        }

        #restart-btn:hover {
            background: rgba(100, 70, 45, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 10px 0 #3f2e1d;
        }

        #restart-btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #3f2e1d;
        }

        .hidden {
            display: none !important;
        }

        /* Audio permission banner */
        #audio-permission-banner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(184, 138, 75, 0.95);
            backdrop-filter: blur(10px);
            border: 3px solid #f5e1b0;
            border-radius: 60px;
            padding: 15px 30px;
            z-index: 100;
            color: #281c0e;
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            white-space: nowrap;
            pointer-events: auto;
        }

        #enable-audio-btn {
            background: #2a3a2a;
            border: 2px solid #f5e1b0;
            color: #f7efd6;
            font-size: 1.2rem;
            padding: 10px 25px;
            border-radius: 40px;
            cursor: pointer;
            font-family: 'Cinzel Decorative', serif;
            transition: all 0.2s;
        }

        #enable-audio-btn:hover {
            background: #3a4f3a;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .question-text { font-size: 1.8rem; }
            .option-btn { font-size: 1.2rem; padding: 15px 5px; }
            #audio-permission-banner { 
                font-size: 1rem; 
                padding: 10px 20px;
                white-space: normal;
                width: 90%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Permission Banner (shown on tablets) -->
    <div id="audio-permission-banner" class="hidden">
        <span>ðŸ”Š Tap to enable the Sorting Hat's voice</span>
        <button id="enable-audio-btn">ENABLE MAGIC</button>
    </div>

    <!-- 3D Canvas Container -->
    <div id="canvas-container"></div>

    <!-- UI Overlay -->
    <div id="quiz-overlay">
        <div id="quiz-panel">
            <h1>THE SORTING HAT</h1>
            <div class="subtitle">"Let the magic decide..."</div>

            <!-- Question Area -->
            <div id="question-area">
                <div class="question-text" id="question-text">Loading your destiny...</div>
                
                <div class="options-grid" id="options-container"></div>

                <div class="voice-section">
                    <button class="mic-btn" id="mic-button">
                        <span>ðŸŽ¤</span> SPEAK YOUR ANSWER
                    </button>
                    <div id="voice-status">Click the button and speak one of the options above</div>
                </div>
            </div>

            <!-- Result Area -->
            <div id="result-area" class="hidden">
                <div class="question-text">The hat has spoken!</div>
                <div id="house-display" class="result-house"></div>
                <button id="restart-btn">â†º BEGIN AGAIN â†»</button>
            </div>
        </div>
    </div>

    <!-- Hidden audio element for initialization -->
    <audio id="audio-init" style="display: none;"></audio>

    <!-- Import Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        // ==================== AUDIO INITIALIZATION ====================
        // This must happen BEFORE any audio playback
        let audioEnabled = false;
        const audioBanner = document.getElementById('audio-permission-banner');
        const enableAudioBtn = document.getElementById('enable-audio-btn');
        const audioInit = document.getElementById('audio-init');
        
        // Check if we're on a mobile/tablet device
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Show banner on mobile devices
        if (isMobile) {
            audioBanner.classList.remove('hidden');
        }

        // Function to enable audio
        function enableAudio() {
            if (audioEnabled) return;
            
            // Create a silent audio context to unlock audio on iOS
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const audioCtx = new AudioContext();
                audioCtx.resume().then(() => {
                    console.log('Audio context resumed');
                });
            }
            
            // Play and immediately pause a silent audio element
            audioInit.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABIAD///////////////////////////////////////////8AAAA8TEFNRTMuMTAwAc0AAAAAAAAAABSAJAiCQcgMgABIAIAAAGkgUw0AAABmgAAA0A==';
            audioInit.play().then(() => {
                audioInit.pause();
                audioInit.currentTime = 0;
                audioEnabled = true;
                audioBanner.classList.add('hidden');
                console.log('Audio enabled');
                
                // Now we can speak the first question
                if (typeof speak === 'function') {
                    speak('The sorting hat is ready. Let the ceremony begin!');
                }
            }).catch(e => {
                console.log('Audio enable error:', e);
                // Still mark as enabled to try speech synthesis
                audioEnabled = true;
                audioBanner.classList.add('hidden');
            });
        }

        // Event listeners for enabling audio
        enableAudioBtn.addEventListener('click', enableAudio);
        
        // Also enable on any click on the main panel (user interaction)
        document.getElementById('quiz-panel').addEventListener('click', function enableOnClick() {
            if (!audioEnabled && isMobile) {
                enableAudio();
            }
        });

        // ==================== 3D SCENE ====================
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';

        // Scene setup
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0c14);
        scene.fog = new THREE.Fog(0x0a0c14, 20, 60);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, 5, 15);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableZoom = false;
        controls.enablePan = false;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 2.2;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffeedd, 1.2);
        mainLight.position.set(5, 15, 8);
        mainLight.castShadow = true;
        mainLight.receiveShadow = true;
        mainLight.shadow.mapSize.width = 1024;
        mainLight.shadow.mapSize.height = 1024;
        const d = 15;
        mainLight.shadow.camera.left = -d;
        mainLight.shadow.camera.right = d;
        mainLight.shadow.camera.top = d;
        mainLight.shadow.camera.bottom = -d;
        mainLight.shadow.camera.near = 1;
        mainLight.shadow.camera.far = 30;
        scene.add(mainLight);

        // Ground
        const groundGeometry = new THREE.CircleGeometry(30, 32);
        const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x2a2f3a });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -0.5;
        ground.receiveShadow = true;
        scene.add(ground);

        // Platform
        const platformGeo = new THREE.CylinderGeometry(5, 5, 0.8, 32);
        const platformMat = new THREE.MeshStandardMaterial({ color: 0x4a4f5a });
        const platform = new THREE.Mesh(platformGeo, platformMat);
        platform.position.set(0, 0, 0);
        platform.receiveShadow = true;
        platform.castShadow = true;
        scene.add(platform);

        // Sorting Hat Model
        const hatGroup = new THREE.Group();
        
        // Brim
        const brimGeo = new THREE.TorusGeometry(2.0, 0.4, 16, 32);
        const brimMat = new THREE.MeshStandardMaterial({ color: 0x6b4c3b });
        const brim = new THREE.Mesh(brimGeo, brimMat);
        brim.rotation.x = Math.PI / 2;
        brim.position.y = 0.8;
        brim.receiveShadow = true;
        brim.castShadow = true;
        hatGroup.add(brim);

        // Cone
        const coneGeo = new THREE.ConeGeometry(1.6, 3.2, 16);
        const coneMat = new THREE.MeshStandardMaterial({ color: 0x4f3b2c });
        const cone = new THREE.Mesh(coneGeo, coneMat);
        cone.position.y = 2.2;
        cone.castShadow = true;
        cone.receiveShadow = true;
        hatGroup.add(cone);

        // Tip
        const tipGeo = new THREE.SphereGeometry(0.3, 8);
        const tipMat = new THREE.MeshStandardMaterial({ color: 0xccaa77, emissive: 0x332211 });
        const tip = new THREE.Mesh(tipGeo, tipMat);
        tip.position.y = 3.6;
        tip.castShadow = true;
        hatGroup.add(tip);

        // Eyes
        const eyeGeo = new THREE.SphereGeometry(0.2, 6);
        const eyeMat = new THREE.MeshStandardMaterial({ color: 0xffdd99 });
        const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
        leftEye.position.set(-0.6, 2.4, 1.3);
        hatGroup.add(leftEye);
        
        const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
        rightEye.position.set(0.6, 2.4, 1.3);
        hatGroup.add(rightEye);

        hatGroup.position.y = 0.5;
        scene.add(hatGroup);

        // Floating particles (magic dust)
        const particleCount = 200;
        const particleGeo = new THREE.BufferGeometry();
        const particlePositions = new Float32Array(particleCount * 3);
        for (let i = 0; i < particleCount; i++) {
            particlePositions[i*3] = (Math.random() - 0.5) * 25;
            particlePositions[i*3+1] = (Math.random() - 0.5) * 10 + 3;
            particlePositions[i*3+2] = (Math.random() - 0.5) * 20;
        }
        particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        const particleMat = new THREE.PointsMaterial({ color: 0x88aaff, size: 0.1, transparent: true, blending: THREE.AdditiveBlending });
        const particles = new THREE.Points(particleGeo, particleMat);
        scene.add(particles);

        // Animation loop
        let clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            const elapsedTime = performance.now() / 1000;

            // Animate hat
            hatGroup.position.y = 0.5 + Math.sin(elapsedTime * 2) * 0.1;
            hatGroup.rotation.y += 0.005;

            // Animate particles
            particles.rotation.y += 0.0005;

            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ==================== QUIZ LOGIC ====================
        const questions = [
            { 
                q: "Which class would you like the most?", 
                options: { 
                    "Potions": "G", 
                    "Herbology": "H", 
                    "Charms": "R", 
                    "Defense": "S" 
                } 
            },
            { 
                q: "Which ability would you prefer?", 
                options: { 
                    "Courage": "G", 
                    "Loyalty": "H", 
                    "Wisdom": "R", 
                    "Ambition": "S" 
                } 
            },
            { 
                q: "Choose a magical creature:", 
                options: { 
                    "Lion": "G", 
                    "Badger": "H", 
                    "Eagle": "R", 
                    "Serpent": "S" 
                } 
            },
            { 
                q: "Favorite color?", 
                options: { 
                    "Scarlet": "G", 
                    "Yellow": "H", 
                    "Blue": "R", 
                    "Green": "S" 
                } 
            },
            { 
                q: "Which element speaks to you?", 
                options: { 
                    "Fire": "G", 
                    "Earth": "H", 
                    "Air": "R", 
                    "Water": "S" 
                } 
            },
            { 
                q: "Choose your path:", 
                options: { 
                    "Bravery": "G", 
                    "Friendship": "H", 
                    "Knowledge": "R", 
                    "Power": "S" 
                } 
            }
        ];

        let currentQuestion = 0;
        let scores = { G: 0, H: 0, R: 0, S: 0 };
        let isListening = false;
        let recognition = null;

        // DOM elements
        const questionArea = document.getElementById('question-area');
        const resultArea = document.getElementById('result-area');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const micButton = document.getElementById('mic-button');
        const voiceStatus = document.getElementById('voice-status');
        const houseDisplay = document.getElementById('house-display');
        const restartBtn = document.getElementById('restart-btn');

        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        }

        // Speak function (deep, magical voice) with mobile handling
        function speak(text, callback) {
            if (!window.speechSynthesis) {
                console.log('Speech synthesis not supported');
                if (callback) callback();
                return;
            }

            // On mobile, wait for audio to be enabled
            if (isMobile && !audioEnabled) {
                voiceStatus.textContent = 'ðŸ”Š Tap "ENABLE MAGIC" to hear the Sorting Hat';
                if (callback) callback();
                return;
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            
            // Configure for deep, magical voice
            utterance.pitch = 0.4;
            utterance.rate = 0.7;
            utterance.volume = 1;
            
            // Try to find a deep voice
            const voices = window.speechSynthesis.getVoices();
            const deepVoice = voices.find(v => 
                v.name.includes('Daniel') || 
                v.name.includes('UK') || 
                v.name.includes('Alex') ||
                v.name.includes('Male') ||
                v.name.includes('Google UK')
            );
            if (deepVoice) utterance.voice = deepVoice;
            
            utterance.onend = () => {
                if (callback) callback();
            };
            
            utterance.onerror = (e) => {
                console.log('Speech error:', e);
                if (callback) callback();
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // Load voices (for Safari/Chrome)
        if (window.speechSynthesis) {
            window.speechSynthesis.getVoices();
        }

        // Display current question
        function displayQuestion() {
            if (currentQuestion < questions.length) {
                const q = questions[currentQuestion];
                questionText.textContent = q.q;
                
                // Clear and create new option buttons
                optionsContainer.innerHTML = '';
                
                Object.entries(q.options).forEach(([text, house]) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = text;
                    button.onclick = () => selectOption(text, house);
                    optionsContainer.appendChild(button);
                });

                // Speak the question (if audio is enabled or not mobile)
                if (!isMobile || audioEnabled) {
                    speak(q.q);
                } else {
                    voiceStatus.textContent = 'ðŸ”Š Tap "ENABLE MAGIC" above to hear the Sorting Hat';
                }
                
                voiceStatus.textContent = 'Click the mic button to speak your answer';
            } else {
                showResult();
            }
        }

        // Handle option selection (text/click)
        function selectOption(optionText, houseCode) {
            // Disable all option buttons temporarily
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });

            // Update scores
            scores[houseCode]++;
            
            // Provide feedback
            voiceStatus.textContent = `You chose: ${optionText}`;
            speak(`You chose ${optionText}`, () => {
                // Move to next question
                currentQuestion++;
                
                // Re-enable buttons for next question
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                
                displayQuestion();
            });
        }

        // Handle voice input
        function startVoiceRecognition() {
            if (!recognition) {
                voiceStatus.textContent = 'Voice recognition not supported in your browser';
                return;
            }

            if (currentQuestion >= questions.length) {
                voiceStatus.textContent = 'The sorting is complete!';
                return;
            }

            if (isListening) return;

            isListening = true;
            micButton.classList.add('listening');
            voiceStatus.textContent = 'ðŸŽ¤ Listening... speak one of the options';

            try {
                recognition.start();
            } catch (e) {
                console.error('Recognition error:', e);
                isListening = false;
                micButton.classList.remove('listening');
                voiceStatus.textContent = 'Error starting voice recognition. Try again.';
            }
        }

        // Setup voice recognition handlers
        if (recognition) {
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript.toLowerCase().trim();
                voiceStatus.textContent = `You said: "${speechResult}"`;
                
                // Match with options
                const currentQ = questions[currentQuestion];
                let matchedOption = null;
                let matchedHouse = null;
                
                Object.entries(currentQ.options).forEach(([text, house]) => {
                    if (text.toLowerCase().includes(speechResult) || 
                        speechResult.includes(text.toLowerCase())) {
                        matchedOption = text;
                        matchedHouse = house;
                    }
                });

                if (matchedOption && matchedHouse) {
                    selectOption(matchedOption, matchedHouse);
                } else {
                    voiceStatus.textContent = 'âŒ Not recognized. Please click an option button.';
                    speak('I did not understand. Please select an option by clicking.');
                }
                
                isListening = false;
                micButton.classList.remove('listening');
            };

            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                voiceStatus.textContent = `Voice error: ${event.error}. Please use buttons.`;
                isListening = false;
                micButton.classList.remove('listening');
            };

            recognition.onend = () => {
                isListening = false;
                micButton.classList.remove('listening');
            };
        }

        // Show final result
        function showResult() {
            questionArea.classList.add('hidden');
            resultArea.classList.remove('hidden');

            // Calculate winning house
            const houses = { G: 'Gryffindor', H: 'Hufflepuff', R: 'Ravenclaw', S: 'Slytherin' };
            const winner = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            const houseName = houses[winner];
            
            houseDisplay.textContent = houseName + '!';
            houseDisplay.className = `result-house house-${houseName}`;
            
            // Speak the result
            speak(`The sorting hat chooses... ${houseName}!`);
        }

        // Restart quiz
        function restartQuiz() {
            currentQuestion = 0;
            scores = { G: 0, H: 0, R: 0, S: 0 };
            
            questionArea.classList.remove('hidden');
            resultArea.classList.add('hidden');
            
            // Reset all buttons
            displayQuestion();
        }

        // Event listeners
        micButton.addEventListener('click', startVoiceRecognition);
        restartBtn.addEventListener('click', restartQuiz);

        // Start the quiz
        displayQuestion();

        // Preload voices
        if (window.speechSynthesis) {
            window.speechSynthesis.getVoices();
        }

        // Handle visibility change to prevent speech issues
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                window.speechSynthesis?.cancel();
            }
        });
    </script>
</body>
</html>
